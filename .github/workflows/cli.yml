name: CLI weekly live test

on:
  schedule:
    - cron: "0 18 * * 0"
  workflow_dispatch:
    inputs:
      test-cases:
        description: 'Specific test cases to run. Example: ["test_integration_create_aws", "test_integration_delete"]. Leave empty to run all test cases'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: engineering
    outputs:
      test-cases: ${{ steps.list-cases.outputs.test-cases }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{secrets.APICEXT_TEST_AZURE_CLIENT_ID}}
          tenant-id: ${{secrets.APICEXT_TEST_AZURE_TENANT_ID}}
          subscription-id: ${{secrets.APICEXT_TEST_AZURE_SUBSCRIPTION_ID}}
          enable-AzPSSession: true

      - name: Clone azure-cli-extensions repository
        run: |
          git clone https://github.com/blackchoey/azure-cli-extensions.git
          cd azure-cli-extensions
          git checkout main

      - name: Setup development environment
        run: |
          cd azure-cli-extensions
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install azdev
          azdev setup -r .
          azdev extension add apic-extension

      - name: Discover test cases
        id: list-cases
        run: |
          # Check if specific test cases are provided via workflow_dispatch
          inputCases='${{ github.event.inputs.test-cases }}'
          if [ -n "$inputCases" ] && [ "$inputCases" != "null" ]; then
            echo "test-cases=$inputCases" >> $GITHUB_OUTPUT
            echo "Using manually specified test cases: $inputCases"
          else
            # Automatically discover test cases using pytest --collect-only
            cd azure-cli-extensions
            source .venv/bin/activate
            cd src/apic-extension

            echo "Discovering test cases using pytest --collect-only..."

            # Use pytest to collect all test cases and extract test function names
            # Run pytest from the apic-extension directory to ensure proper discovery
            test_collection_output=$(python -m pytest --collect-only -q 2>/dev/null || true)

            echo "Raw pytest output:"
            echo "$test_collection_output"

            # Extract test function names from pytest collection output
            # Handle both formats: <TestCaseFunction name> and path::Class::test_name
            if echo "$test_collection_output" | grep -q "<TestCaseFunction"; then
              # Format: <TestCaseFunction test_name>
              test_collection=$(echo "$test_collection_output" | grep -E "^\s*<TestCaseFunction" | sed -E 's/.*<TestCaseFunction ([^>]+)>.*/\1/' | sort | uniq)
            elif echo "$test_collection_output" | grep -q "::test_"; then
              # Format: path/file.py::ClassName::test_name
              test_collection=$(echo "$test_collection_output" | grep -E "::test_" | sed -E 's/.*::([^:]+)$/\1/' | sort | uniq)
            else
              # No recognized format found
              test_collection=""
            fi

            if [ -n "$test_collection" ]; then
              test_count=$(echo "$test_collection" | wc -l)
              echo "Discovered $test_count test cases:"
              echo "$test_collection"

              # Convert to JSON array format (compact, single-line)
              test_cases=$(echo "$test_collection" | jq -R -s -c 'split("\n") | map(select(length > 0))')
              total_tests=$(echo "$test_cases" | jq '. | length')
              echo "Found $total_tests test cases"

              # Split test cases across 4 Python versions (roughly equal distribution)
              # Each job should have roughly 124/4 = 31 test cases to stay under 256 limit
              quarter_size=$((total_tests / 4))
              remainder=$((total_tests % 4))

              # Calculate sizes for each chunk (distribute remainder across first few chunks)
              size_py39=$((quarter_size + (remainder > 0 ? 1 : 0)))
              size_py310=$((quarter_size + (remainder > 1 ? 1 : 0)))
              size_py311=$((quarter_size + (remainder > 2 ? 1 : 0)))
              size_py312=$quarter_size

              # Split test cases into chunks
              test_cases_py39=$(echo "$test_cases" | jq -c ".[0:$size_py39]")
              test_cases_py310=$(echo "$test_cases" | jq -c ".[$size_py39:$((size_py39 + size_py310))]")
              test_cases_py311=$(echo "$test_cases" | jq -c ".[$((size_py39 + size_py310)):$((size_py39 + size_py310 + size_py311))]")
              test_cases_py312=$(echo "$test_cases" | jq -c ".[$((size_py39 + size_py310 + size_py311)):]")

              echo "test-cases-py39=$test_cases_py39" >> $GITHUB_OUTPUT
              echo "test-cases-py310=$test_cases_py310" >> $GITHUB_OUTPUT
              echo "test-cases-py311=$test_cases_py311" >> $GITHUB_OUTPUT
              echo "test-cases-py312=$test_cases_py312" >> $GITHUB_OUTPUT

              echo "Python 3.9: $(echo "$test_cases_py39" | jq '. | length') test cases"
              echo "Python 3.10: $(echo "$test_cases_py310" | jq '. | length') test cases"
              echo "Python 3.11: $(echo "$test_cases_py311" | jq '. | length') test cases"
              echo "Python 3.12: $(echo "$test_cases_py312" | jq '. | length') test cases"
              echo "Using pytest discovered test cases split across Python versions"
            else
              echo "No test cases found using pytest --collect-only"
              echo "This will trigger full test suite execution instead"
              # Fallback to empty array to trigger full test suite
              echo "test-cases-py39=[]" >> $GITHUB_OUTPUT
              echo "test-cases-py310=[]" >> $GITHUB_OUTPUT
              echo "test-cases-py311=[]" >> $GITHUB_OUTPUT
              echo "test-cases-py312=[]" >> $GITHUB_OUTPUT
            fi
          fi

  execute-test-case-py39:
    needs: setup
    runs-on: ubuntu-latest
    environment: engineering
    strategy:
      fail-fast: false
      matrix:
        # Use discovered test cases if available, otherwise use a single placeholder
        test-case: ${{ fromJson(needs.setup.outputs.test-cases-py39 != '[]' && needs.setup.outputs.test-cases-py39 || '["full-suite"]') }}
    name: ${{ matrix.test-case == 'full-suite' && 'Run Full Test Suite (Python 3.9)' || format('{0} (Python 3.9)', matrix.test-case) }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.9"

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{secrets.APICEXT_TEST_AZURE_CLIENT_ID}}
          tenant-id: ${{secrets.APICEXT_TEST_AZURE_TENANT_ID}}
          subscription-id: ${{secrets.APICEXT_TEST_AZURE_SUBSCRIPTION_ID}}
          enable-AzPSSession: true

      - name: Clone azure-cli-extensions repository
        run: |
          git clone https://github.com/blackchoey/azure-cli-extensions.git
          cd azure-cli-extensions
          git checkout main

      - name: Setup development environment
        run: |
          cd azure-cli-extensions
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install azdev
          azdev setup -r .
          azdev extension add apic-extension

      - name: Run tests
        run: |
          cd azure-cli-extensions
          source .venv/bin/activate
          if [ "${{ matrix.test-case }}" = "full-suite" ]; then
            echo "Running full test suite..."
            azdev test apic-extension --discover --live
          else
            echo "Running individual test case: ${{ matrix.test-case }}"
            azdev test azext_apic-extension ${{ matrix.test-case }} --discover --live
          fi
        env:
          USERASSIGNED_IDENTITY: ${{ secrets.USERASSIGNED_IDENTITY }}
          AWS_ACCESS_KEY_LINK: ${{ secrets.AWS_ACCESS_KEY_LINK }}
          AWS_SECRET_ACCESS_KEY_LINK: ${{ secrets.AWS_SECRET_ACCESS_KEY_LINK }}
  execute-test-case-py310:
    needs: setup
    runs-on: ubuntu-latest
    environment: engineering
    strategy:
      fail-fast: false
      matrix:
        # Use discovered test cases if available, otherwise use a single placeholder
        test-case: ${{ fromJson(needs.setup.outputs.test-cases-py310 != '[]' && needs.setup.outputs.test-cases-py310 || '["full-suite"]') }}
    name: ${{ matrix.test-case == 'full-suite' && 'Run Full Test Suite (Python 3.10)' || format('{0} (Python 3.10)', matrix.test-case) }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{secrets.APICEXT_TEST_AZURE_CLIENT_ID}}
          tenant-id: ${{secrets.APICEXT_TEST_AZURE_TENANT_ID}}
          subscription-id: ${{secrets.APICEXT_TEST_AZURE_SUBSCRIPTION_ID}}
          enable-AzPSSession: true

      - name: Clone azure-cli-extensions repository
        run: |
          git clone https://github.com/blackchoey/azure-cli-extensions.git
          cd azure-cli-extensions
          git checkout main

      - name: Setup development environment
        run: |
          cd azure-cli-extensions
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install azdev
          azdev setup -r .
          azdev extension add apic-extension

      - name: Run tests
        run: |
          cd azure-cli-extensions
          source .venv/bin/activate
          if [ "${{ matrix.test-case }}" = "full-suite" ]; then
            echo "Running full test suite..."
            azdev test apic-extension --discover --live
          else
            echo "Running individual test case: ${{ matrix.test-case }}"
            azdev test azext_apic-extension ${{ matrix.test-case }} --discover --live
          fi
        env:
          USERASSIGNED_IDENTITY: ${{ secrets.USERASSIGNED_IDENTITY }}
          AWS_ACCESS_KEY_LINK: ${{ secrets.AWS_ACCESS_KEY_LINK }}
          AWS_SECRET_ACCESS_KEY_LINK: ${{ secrets.AWS_SECRET_ACCESS_KEY_LINK }}
  execute-test-case-py311:
    needs: setup
    runs-on: ubuntu-latest
    environment: engineering
    strategy:
      fail-fast: false
      matrix:
        # Use discovered test cases if available, otherwise use a single placeholder
        test-case: ${{ fromJson(needs.setup.outputs.test-cases-py311 != '[]' && needs.setup.outputs.test-cases-py311 || '["full-suite"]') }}
    name: ${{ matrix.test-case == 'full-suite' && 'Run Full Test Suite (Python 3.11)' || format('{0} (Python 3.11)', matrix.test-case) }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{secrets.APICEXT_TEST_AZURE_CLIENT_ID}}
          tenant-id: ${{secrets.APICEXT_TEST_AZURE_TENANT_ID}}
          subscription-id: ${{secrets.APICEXT_TEST_AZURE_SUBSCRIPTION_ID}}
          enable-AzPSSession: true

      - name: Clone azure-cli-extensions repository
        run: |
          git clone https://github.com/blackchoey/azure-cli-extensions.git
          cd azure-cli-extensions
          git checkout main

      - name: Setup development environment
        run: |
          cd azure-cli-extensions
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install azdev
          azdev setup -r .
          azdev extension add apic-extension

      - name: Run tests
        run: |
          cd azure-cli-extensions
          source .venv/bin/activate
          if [ "${{ matrix.test-case }}" = "full-suite" ]; then
            echo "Running full test suite..."
            azdev test apic-extension --discover --live
          else
            echo "Running individual test case: ${{ matrix.test-case }}"
            azdev test azext_apic-extension ${{ matrix.test-case }} --discover --live
          fi
        env:
          USERASSIGNED_IDENTITY: ${{ secrets.USERASSIGNED_IDENTITY }}
          AWS_ACCESS_KEY_LINK: ${{ secrets.AWS_ACCESS_KEY_LINK }}
          AWS_SECRET_ACCESS_KEY_LINK: ${{ secrets.AWS_SECRET_ACCESS_KEY_LINK }}
  execute-test-case-py312:
    needs: setup
    runs-on: ubuntu-latest
    environment: engineering
    strategy:
      fail-fast: false
      matrix:
        # Use discovered test cases if available, otherwise use a single placeholder
        test-case: ${{ fromJson(needs.setup.outputs.test-cases-py312 != '[]' && needs.setup.outputs.test-cases-py312 || '["full-suite"]') }}
    name: ${{ matrix.test-case == 'full-suite' && 'Run Full Test Suite (Python 3.12)' || format('{0} (Python 3.12)', matrix.test-case) }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.12"

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{secrets.APICEXT_TEST_AZURE_CLIENT_ID}}
          tenant-id: ${{secrets.APICEXT_TEST_AZURE_TENANT_ID}}
          subscription-id: ${{secrets.APICEXT_TEST_AZURE_SUBSCRIPTION_ID}}
          enable-AzPSSession: true

      - name: Clone azure-cli-extensions repository
        run: |
          git clone https://github.com/blackchoey/azure-cli-extensions.git
          cd azure-cli-extensions
          git checkout main

      - name: Setup development environment
        run: |
          cd azure-cli-extensions
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install -U pip
          pip install azdev
          azdev setup -r .
          azdev extension add apic-extension

      - name: Run tests
        run: |
          cd azure-cli-extensions
          source .venv/bin/activate
          if [ "${{ matrix.test-case }}" = "full-suite" ]; then
            echo "Running full test suite..."
            azdev test apic-extension --discover --live
          else
            echo "Running individual test case: ${{ matrix.test-case }}"
            azdev test azext_apic-extension ${{ matrix.test-case }} --discover --live
          fi
        env:
          USERASSIGNED_IDENTITY: ${{ secrets.USERASSIGNED_IDENTITY }}
          AWS_ACCESS_KEY_LINK: ${{ secrets.AWS_ACCESS_KEY_LINK }}
          AWS_SECRET_ACCESS_KEY_LINK: ${{ secrets.AWS_SECRET_ACCESS_KEY_LINK }}
  notify:
    needs: [setup, execute-test-case-py39, execute-test-case-py310, execute-test-case-py311, execute-test-case-py312]
    if: always() && !cancelled() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    environment: engineering
    steps:
      - name: Generate Email Content
        id: generate-email-content
        run: |
          # Get the test cases that were executed across all Python versions
          test_cases_py39='${{ needs.setup.outputs.test-cases-py39 }}'
          test_cases_py310='${{ needs.setup.outputs.test-cases-py310 }}'
          test_cases_py311='${{ needs.setup.outputs.test-cases-py311 }}'
          test_cases_py312='${{ needs.setup.outputs.test-cases-py312 }}'

          # Initialize report variables
          total_jobs=0
          passed_jobs=0
          failed_jobs=0
          passed_tests=""
          failed_tests=""

          # Fetch individual job results using GitHub API
          page=1
          jobs="[]"

          while :
          do
            url="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}/jobs?per_page=100&page=$page"
            resp=$(curl -H "Accept: application/vnd.github.v3+json" -u:${{ secrets.GITHUB_TOKEN }} "$url")
            new_jobs=$(echo "$resp" | jq -cr '.jobs')
            jobs=$(jq -cr --slurp 'add' <(echo "$jobs") <(echo "$new_jobs"))

            has_next=$(curl -I -H "Accept: application/vnd.github.v3+json" -u:${{ secrets.GITHUB_TOKEN }} "$url" | grep -Fi "link:" | grep "rel=\"last\"" || true)
            if [ -z "$has_next" ]; then
              break
            fi
            page=$((page+1))
          done

          # Process results for each Python version job
          declare -A py_test_cases
          py_test_cases["py39"]="$test_cases_py39"
          py_test_cases["py310"]="$test_cases_py310"
          py_test_cases["py311"]="$test_cases_py311"
          py_test_cases["py312"]="$test_cases_py312"

          declare -A py_versions
          py_versions["py39"]="3.9"
          py_versions["py310"]="3.10"
          py_versions["py311"]="3.11"
          py_versions["py312"]="3.12"

          for py_key in py39 py310 py311 py312; do
            test_cases="${py_test_cases[$py_key]}"
            python_version="${py_versions[$py_key]}"

            if [ "$test_cases" = "[]" ]; then
              # Full suite was run for this Python version
              job_name="Run Full Test Suite (Python ${python_version})"
              job_result=$(echo "$jobs" | jq -r --arg name "$job_name" '.[] | select(.name == $name) | .conclusion')

              total_jobs=$((total_jobs + 1))
              if [ "$job_result" = "success" ]; then
                passed_jobs=$((passed_jobs + 1))
                if [ -z "$passed_tests" ]; then
                  passed_tests="$job_name"
                else
                  passed_tests="${passed_tests}"$'\n'"${job_name}"
                fi
              else
                failed_jobs=$((failed_jobs + 1))
                if [ -z "$failed_tests" ]; then
                  failed_tests="$job_name"
                else
                  failed_tests="${failed_tests}"$'\n'"${job_name}"
                fi
              fi
            else
              # Individual test cases were run for this Python version
              test_case_array=$(echo "$test_cases" | jq -r '.[]')

              for test_case in $test_case_array; do
                total_jobs=$((total_jobs + 1))

                # Find job by exact name match (includes Python version)
                job_name="${test_case} (Python ${python_version})"
                job_result=$(echo "$jobs" | jq -r --arg name "$job_name" '.[] | select(.name == $name) | .conclusion')

                if [ "$job_result" = "success" ]; then
                  passed_jobs=$((passed_jobs + 1))
                  if [ -z "$passed_tests" ]; then
                    passed_tests="$job_name"
                  else
                    passed_tests="${passed_tests}"$'\n'"${job_name}"
                  fi                else
                  failed_jobs=$((failed_jobs + 1))
                  if [ -z "$failed_tests" ]; then
                    failed_tests="$job_name"
                  else
                    failed_tests="${failed_tests}"$'\n'"${job_name}"
                  fi
                fi
              done
            fi
          done

          # Generate email subject
          if [ $failed_jobs -eq 0 ]; then
            subject="[APICENTER] Weekly APIC Extension Live Test - All Tests Passed ‚úÖ"
          else
            subject="[APICENTER] Weekly APIC Extension Live Test - $failed_jobs/$total_jobs Tests Failed ‚ùå"
          fi

          # Generate HTML email body with proper formatting
          body="<html><body>"
          body="${body}<h2>APIC Extension Live Test Report</h2>"
          body="${body}<h3>üìä Summary:</h3>"
          body="${body}<ul>"
          body="${body}<li><strong>Total Test Cases:</strong> $total_jobs</li>"
          body="${body}<li><strong>Passed:</strong> $passed_jobs</li>"
          body="${body}<li><strong>Failed:</strong> $failed_jobs</li>"

          if [ $total_jobs -gt 0 ]; then
            success_rate=$(( (passed_jobs * 100) / total_jobs ))
            body="${body}<li><strong>Success Rate:</strong> ${success_rate}%</li>"
          fi
          body="${body}</ul>"

          if [ -n "$failed_tests" ]; then
            body="${body}<h3>‚ùå Failed Tests:</h3><ul>"
            while IFS= read -r test; do
              if [ -n "$test" ]; then
                body="${body}<li>${test}</li>"
              fi
            done <<< "$failed_tests"
            body="${body}</ul>"
          fi

          if [ -n "$passed_tests" ]; then
            body="${body}<h3>‚úÖ Passed Tests:</h3><ul>"
            while IFS= read -r test; do
              if [ -n "$test" ]; then
                body="${body}<li>${test}</li>"
              fi
            done <<< "$passed_tests"
            body="${body}</ul>"
          fi

          body="${body}<h3>üîó Workflow Details:</h3>"
          body="${body}<ul>"
          body="${body}<li><strong>Workflow URL:</strong> <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow Run</a></li>"
          body="${body}<li><strong>Repository:</strong> ${{ github.repository }}</li>"
          body="${body}<li><strong>Branch:</strong> ${{ github.ref_name }}</li>"
          body="${body}<li><strong>Triggered by:</strong> ${{ github.event_name }}</li>"
          body="${body}<li><strong>Run ID:</strong> ${{ github.run_id }}</li>"
          body="${body}<li><strong>Run Attempt:</strong> ${{ github.run_attempt }}</li>"
          body="${body}</ul>"
          body="${body}</body></html>"

          # Set environment variables for outputs
          echo "to=${{ secrets.AUTHOR_MAIL_ADDRESSES }}" >> $GITHUB_ENV
          echo "subject=$subject" >> $GITHUB_ENV
          echo "body=$body" >> $GITHUB_ENV

      - name: Send Email Notification
        run: |
          response=$(curl \
            --request POST \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data "grant_type=client_credentials&client_id=${{ secrets.MAIL_CLIENT_ID }}&client_secret=${{ secrets.MAIL_CLIENT_SECRET }}&resource=https://management.core.windows.net" \
            "https://login.microsoftonline.com/${{ secrets.MAIL_TENANT_ID }}/oauth2/token")

          access_token=$(echo $response | jq -r '. | select(.access_token) | .access_token')

          curl \
            --request POST \
            --header "Content-Type: application/json" \
            --header "Authorization: Bearer $access_token" \
            --data "{\"to\": \"${{ env.to }}\", \"body\": \"${{ env.body }}\", \"subject\": \"${{ env.subject }}\"}" \
            'https://prod-18.northcentralus.logic.azure.com:443/workflows/b33d7861bfc64832a6f62cc8f2213988/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0'
        shell: bash
